<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–µ–∞–Ω—Å—É ‚Äî —Ü—ñ–Ω–∏ —Ç–∞ –∑–æ–Ω–∏</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, sans-serif;
  background:#f3f4f6;
  margin:0;
  padding:20px;
}
.wrap{max-width:980px;margin:auto;}
h1{margin-bottom:6px}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
label{font-size:14px}
input,select,button,textarea{
  padding:8px 10px;
  font-size:14px;
}
button{cursor:pointer}
textarea{
  width:100%;
  height:260px;
  font-family:monospace;
}
.badge{
  font-size:12px;
  padding:2px 8px;
  border-radius:6px;
  background:#e5e7eb;
  display:inline-block;
}

.rule-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:6px;
  font-size:14px;
}
.rule-color{
  width:18px;
  height:18px;
  border-radius:4px;
  border:1px solid #999;
}
.rule-del{
  border:none;
  background:#fee2e2;
  border-radius:6px;
  padding:4px 8px;
}
.rule-del:hover{background:#fecaca}
small{color:#6b7280}
</style>
</head>

<body>
<div class="wrap">

<h1>üéõÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä seance.json</h1>
<span class="badge">–¶—ñ–Ω–∏ + –∫–æ–ª—å–æ—Ä–∏ + –æ–∫—Ä–µ–º—ñ –º—ñ—Å—Ü—è (–æ–¥–∏–Ω —Å–µ–∞–Ω—Å)</span>

<!-- Seance -->
<div class="card">
  <div class="row">
    <label>Seance ID</label>
    <input id="seanceId" placeholder="koncert-2026-02-10-19-00" style="flex:1">
    <button onclick="loadSeance()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </div>
</div>

<!-- Rules -->
<div class="card">
  <h3>‚ûï –ü—Ä–∞–≤–∏–ª–æ –ø–æ —Ä—è–¥–∞—Ö</h3>

  <div class="row">
    <label>–ó–æ–Ω–∞</label>
    <select id="zone">
      <option value="P">–ü–∞—Ä—Ç–µ—Ä</option>
      <option value="A">–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä</option>
      <option value="B">–ë–∞–ª–∫–æ–Ω</option>
    </select>

    <label>–†—è–¥–∏</label>
    <input id="fromRow" type="number" placeholder="–≤—ñ–¥">
    <input id="toRow" type="number" placeholder="–¥–æ">

    <label>–¶—ñ–Ω–∞</label>
    <input id="price" type="number" placeholder="200">

    <label>–ö–æ–ª—ñ—Ä</label>
    <input id="color" type="color" value="#9333ea">

    <label>
      <input type="checkbox" id="sale" checked>
      –ü—Ä–æ–¥–∞—î—Ç—å—Å—è
    </label>

    <button onclick="addRule()">–î–æ–¥–∞—Ç–∏</button>
  </div>

  <small>–ú–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–≤–≥–æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª ‚Äî –≤—Å—ñ –ø—Ä–∞—Ü—é—é—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–æ</small>
</div>

<!-- Rules list -->
<div class="card">
  <h3>üìã –ü—Ä–∞–≤–∏–ª–∞ —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É</h3>
  <div id="rulesList"></div>
</div>

<!-- Seat override -->
<div class="card">
  <h3>üéØ –û–∫—Ä–µ–º–µ –º—ñ—Å—Ü–µ</h3>
  <div class="row">
    <input id="seatKey" placeholder="P3-M5">
    <input id="seatPrice" type="number" placeholder="—Ü—ñ–Ω–∞">
    <input id="seatColor" type="color" value="#ef4444">
    <label>
      <input type="checkbox" id="seatSale">
      –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –ø—Ä–æ–¥–∞–∂
    </label>
    <button onclick="addSeatOverride()">–î–æ–¥–∞—Ç–∏</button>
  </div>
</div>

<!-- JSON -->
<div class="card">
  <h3>üìÑ seance.json</h3>
  <textarea id="output"></textarea>
  <button onclick="copy()">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
</div>

<button id="publish">üöÄ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>

</div>

<script>
const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_nCCfptJOb8Lzy1uAwGBJzA_OJtDneTS";
const SUPABASE_FUNCTION_URL =
  "https://fhusjlkneckbvnrdhbil.supabase.co/functions/v1/save-seance";

const data = {
  pricing: {},
  seat_overrides: {}
};

function addRule(){
  const z = document.getElementById("zone").value;
  const from = Number(document.getElementById("fromRow").value);
  const to   = Number(document.getElementById("toRow").value);
  const p    = Number(document.getElementById("price").value);
  const c    = document.getElementById("color").value;
  const saleAllowed = document.getElementById("sale").checked;

  if (!z || !from || !to || !p) {
    alert("‚ùó –í–∫–∞–∂–∏ –∑–æ–Ω—É, —Ä—è–¥–∏ –í–Ü–î‚Äì–î–û —ñ —Ü—ñ–Ω—É");
    return;
  }

  if (from > to) {
    alert("‚ùó –†—è–¥ '–≤—ñ–¥' –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à–∏–º –∑–∞ '–¥–æ'");
    return;
  }

  const key = `${z}${from}-${to}`;

  data.pricing[key] = {
    price: p,
    color: c,
    sale: saleAllowed
  };

  render();
}


function removeRule(key){
  delete data.pricing[key];
  render();
}

function renderRulesList(){
  rulesList.innerHTML = Object.entries(data.pricing).map(([k,r])=>`
    <div class="rule-row">
      <span class="rule-color" style="background:${r.color}"></span>
      <b>${k}</b>
      <span>${r.price} –≥—Ä–Ω</span>
      <span>${r.sale === false ? "‚ùå –Ω–µ –ø—Ä–æ–¥–∞—î—Ç—å—Å—è" : "‚úî –ø—Ä–æ–¥–∞—î—Ç—å—Å—è"}</span>
      <button class="rule-del" onclick="removeRule('${k}')">‚úñ</button>
    </div>
  `).join("") || "<small>–ü–æ–∫–∏ —â–æ –ø—Ä–∞–≤–∏–ª –Ω–µ–º–∞—î</small>";
}

function addSeatOverride(){
  const key = seatKey.value.trim();
  if(!key) return;

  const obj = {};
  if(seatPrice.value) obj.price = Number(seatPrice.value);
  obj.color = seatColor.value;
  if(seatSale.checked) obj.sale = false;

  data.seat_overrides[key] = obj;
  render();
}

function render(){
  output.value = JSON.stringify({
    seance_id: seanceId.value.trim(),
    pricing: data.pricing,
    seat_overrides: data.seat_overrides
  }, null, 2);

  const list = document.getElementById("rulesList");
  if (!list) return;

  list.innerHTML = "";

  Object.entries(data.pricing).forEach(([key, r]) => {
    const zone =
      key.startsWith("P") ? "–ü–∞—Ä—Ç–µ—Ä" :
      key.startsWith("A") ? "–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä" :
      key.startsWith("B") ? "–ë–∞–ª–∫–æ–Ω" : "?";

    const rows = key.slice(1); // <-- –í–ê–ñ–ù–û: "1-6"

    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "10px";
    div.style.marginBottom = "6px";

    div.innerHTML = `
      <span style="
        width:16px;
        height:16px;
        border-radius:4px;
        background:${r.color || "#e5e7eb"};
        display:inline-block;
      "></span>
      <b>${zone}</b>
      <span>—Ä—è–¥–∏ <b>${rows}</b></span>
      <span>‚Äî</span>
      <b>${r.price} –≥—Ä–Ω</b>
      <span style="opacity:.6">
        ${r.sale === false ? "‚ùå –Ω–µ –ø—Ä–æ–¥–∞—î—Ç—å—Å—è" : "‚úî –ø—Ä–æ–¥–∞—î—Ç—å—Å—è"}
      </span>
    `;

    list.appendChild(div);
  });
}



function copy(){
  output.select();
  document.execCommand("copy");
  alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ");
}

publish.onclick = async ()=>{
  const seance = seanceId.value.trim();
  if(!seance) return alert("–í–∫–∞–∂–∏ Seance ID");

  const res = await fetch(SUPABASE_FUNCTION_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      seance_id: seance,
      pricing: data.pricing,
      seat_overrides: data.seat_overrides
    })
  });

  alert(res.ok ? "‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ" : "‚ùå –ü–æ–º–∏–ª–∫–∞");
};

async function loadSeance(){
  const seance = seanceId.value.trim();
  if(!seance) return;

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/seances_pricing?seance_id=eq.${encodeURIComponent(seance)}&select=pricing,seat_overrides`,
    { headers:{ apikey:SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` } }
  );

  const rows = await res.json();
  if(!rows.length) return alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ");

  data.pricing = rows[0].pricing || {};
  data.seat_overrides = rows[0].seat_overrides || {};
  render();
}
</script>
</body>
</html>
