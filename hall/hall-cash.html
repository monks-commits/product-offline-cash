<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ö–µ–º–∞ –∑–∞–ª—É ‚Äî –∫–∞—Å–∞</title>

  <link rel="stylesheet" href="../styles.css" />

  <!-- QR –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

  <style>
    .hall-layout{display:flex;gap:24px;align-items:flex-start;}
    .hall-left{flex:1 1 auto;min-width:0;}
    .hall-sidebar{width:360px;flex:0 0 360px;}
    .hall-card{margin-top:0;}

    .hall-scroll{
      background:#e5e7eb;border-radius:16px;padding:12px;
      overflow-x:auto;overflow-y:visible;-webkit-overflow-scrolling:touch;
    }
    .hall-inner{
  width: max-content;
  margin: 0 auto;
}


    .hall-section{margin-bottom:18px;}
    .hall-section-title{
      text-align:center;font-size:14px;text-transform:uppercase;
      letter-spacing:.08em;color:#6b7280;margin:4px 0 6px;
    }

    .row-line{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
    .row-label{width:22px;text-align:right;font-size:11px;color:#6b7280;flex:0 0 22px;}
    .seats-row{display:flex;gap:4px;flex-wrap:nowrap;}

    .seat{
      width:24px;height:24px;border-radius:6px;border:1px solid #d1d5db;background:#fff;
      font-size:11px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;padding:0;user-select:none;
    }
  

.seat--no-sale {
  background:#e5e7eb !important;
  color:#9ca3af !important;
  cursor:not-allowed;
}



    .seat--selected{background:#2563eb !important;color:#fff;border-color:#2563eb;}

    .seat--sold{background:#9ca3af !important;color:#fff;border-color:#9ca3af;cursor:not-allowed;}
    .seat--reserved{background:#f59e0b !important;color:#111827;border-color:#f59e0b;}
    .seat--blocked{background:#111827 !important;color:#fff;border-color:#111827;cursor:not-allowed;}

    .seat--gap-right{margin-right:16px;}
    .amphi-gap{width:24px;flex:0 0 24px;}

    .parter-wrap{display:flex;justify-content:center;align-items:flex-start;gap:24px;}
    .hall-lodge{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .hall-lodge-label{font-size:11px;color:#6b7280;margin-bottom:4px;}
    .hall-lodge-seats{display:flex;flex-direction:column;gap:4px;}

    .hall-summary-title{margin-top:0;margin-bottom:8px;}
    .hall-summary-meta{font-size:14px;color:#4b5563;margin:4px 0;}

    .row-price-list{
      margin-top:14px;padding:12px 14px;background:#f7f7f8;border-radius:12px;font-size:14px;
    }
    .row-price{
      display:flex;align-items:center;gap:8px;font-size:14px;color:#0f172a;
      padding:6px 0;border-bottom:1px dotted #e5e7eb;
    }
    .row-price:last-child{border-bottom:0;}
    .row-price .dots{flex:1 1 auto;border-bottom:1px dotted #e5e7eb;height:0;transform:translateY(-2px);}

    .seat--empty{visibility:hidden;pointer-events:none;border:none;background:transparent;}

    .cash-badge{
      display:flex;flex-wrap:wrap;align-items:center;gap:8px;
      background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;
      padding:8px 12px;border-radius:14px;font-size:12px;margin:6px 0 14px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 10px;border-radius:999px;background:#e2e8f0;color:#0f172a;font-size:11px;
      border:1px solid rgba(15,23,42,.08);
    }
    .pill.ok{background:#bbf7d0;}
    .pill.warn{background:#fed7aa;}
    .pill.bad{background:#fecaca;}
    .pill.dark{background:#111827;color:#fff;}

    .cash-actions{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    .btn-sell{background:#fca5a5;color:#111827;}
    .btn-reserve{background:#fed7aa;color:#111827;}
    .btn-clear{background:#e5e7eb;color:#111827;}
    
    .btn-reset{background:#111827;color:#fff;margin-top:6px;}
    .btn-ghost{background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0;}

    .note{
      font-size:12px;color:#6b7280;line-height:1.35;margin-top:10px;
      background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px 12px;
    }

    .smallline{font-size:12px;color:#6b7280;margin-top:8px;line-height:1.35;}
    .k-sep{height:1px;background:#e5e7eb;margin:12px 0;}
    .k-mini{font-size:12px;color:#6b7280;}
    .k-h3{margin:8px 0 6px;font-size:14px;}
    .k-table{width:100%;border-collapse:collapse;font-size:12px;}
    .k-table th,.k-table td{padding:6px 6px;border-bottom:1px solid #eef2f7;vertical-align:top;}
    .k-table th{text-align:left;color:#6b7280;font-weight:700;}
    .k-table td{color:#0f172a;}
    .k-table .muted{color:#6b7280;}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modal{width:min(560px,100%);background:#fff;border-radius:16px;padding:14px;border:1px solid #e5e7eb;box-shadow:0 20px 60px rgba(15,23,42,.25);}
    .modal h2{margin:0 0 10px;}
    .formRow{display:grid;gap:6px;margin:10px 0;}
    .formRow label{font-size:12px;color:#6b7280;}
    .formRow input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px;}
    .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}

.hall-left {
  display: flex;
  justify-content: center;
}

    
    @media (max-width:900px){
      .hall-layout{flex-direction:column;}
      .hall-sidebar{width:auto;}
    }

   
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="main">
    <div class="container">
      <h1>–°—Ö–µ–º–∞ –∑–∞–ª—É ‚Äî –∫–∞—Å–∞</h1>

      <div class="cash-badge">
        <span class="pill dark">–†–µ–∂–∏–º: <b>–∫–∞—Å–∞</b></span>
        
        <button id="btnSettings" class="btn btn-ghost" style="padding:8px 10px;border-radius:999px;">‚öô –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      </div>

      <div class="hall-layout">
        <div class="hall-left">
          <div class="hall-scroll">
            <div class="hall-inner">

              <section class="hall-section">
                <div class="hall-section-title">–ü–∞—Ä—Ç–µ—Ä</div>

                <div class="parter-wrap">
                  <!-- IMPORTANT: –õ–æ–∂–∞ –ê –∑–ª—ñ–≤–∞ -->
                  <div class="hall-lodge">
                    <div class="hall-lodge-label">–õ–æ–∂–∞ –ê</div>
                    <div class="hall-lodge-seats" id="lodge-a-seats"></div>
                  </div>

                  <div id="parter-block"></div>

                  <!-- –õ–æ–∂–∞ –ë —Å–ø—Ä–∞–≤–∞ -->
                  <div class="hall-lodge">
                    <div class="hall-lodge-label">–õ–æ–∂–∞ –ë</div>
                    <div class="hall-lodge-seats" id="lodge-b-seats"></div>
                  </div>
                </div>
              </section>

              <section class="hall-section">
                <div class="hall-section-title">–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä</div>
                <div id="amphi-block"></div>
              </section>

              <section class="hall-section">
                <div class="hall-section-title">–ë–∞–ª–∫–æ–Ω</div>
                <div id="balcony-block"></div>
              </section>

            </div>
          </div>

        

        <aside class="hall-sidebar">
          <div class="card hall-card">
            <h2 class="hall-summary-title">–ö–æ—à–∏–∫ (–∫–∞—Å–∞)</h2>

            <p id="summary-show" class="hall-summary-meta">–í–∏—Å—Ç–∞–≤–∞: ‚Äî</p>
            <p id="summary-seance" class="hall-summary-meta">Seance: ‚Äî</p>
            <p id="summary-places" class="hall-summary-meta">–û–±—Ä–∞–Ω—ñ –º—ñ—Å—Ü—è: –Ω–µ–º–∞—î</p>
            <p id="summary-amount" class="hall-summary-meta">–°—É–º–∞: 0 –≥—Ä–Ω</p>

            <div class="cash-actions">
              <button id="btn-sell" class="btn btn-sell" disabled>–ü–†–û–î–ê–¢–ò (–ö–ê–°–ê) + –î–†–£–ö</button>
              <button id="btn-reserve" class="btn btn-reserve" disabled>–î–û –†–ï–ó–ï–†–í–£</button>
              <button id="btn-clear" class="btn btn-clear">–û–ß–ò–°–¢–ò–¢–ò</button>
            
              <button id="btn-reprint" class="btn btn-ghost" disabled>–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –¥—Ä—É–∫ –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –ø—Ä–æ–¥–∞–∂—ñ</button>
              <button id="btn-reset" class="btn btn-reset">–°–∫–∏–Ω—É—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É</button>
            </div>

            <div class="k-sep"></div>

            <div class="k-h3">–ñ—É—Ä–Ω–∞–ª –∫–∞—Å–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
            <div class="k-mini">–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Ü—å–æ–º—É –ü–ö (localStorage). –î–ª—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ —Ä–µ—î—Å—Ç—Ä—É –ø—Ä–æ–¥–∞–∂—ñ–≤ —ñ—Å—Ç–∏–Ω–∞ ‚Äî Supabase (tickets).</div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 8px;">
              <button id="btnExportCashCsv" class="btn btn-ghost" style="padding:8px 10px;">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
              <button id="btnClearCashLog" class="btn btn-ghost" style="padding:8px 10px;">–û—á–∏—Å—Ç–∏—Ç–∏ –∂—É—Ä–Ω–∞–ª</button>
            </div>

            <div style="max-height:220px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;">
              <table class="k-table" id="cashLogTable">
                <thead>
                  <tr>
                    <th>–ß–∞—Å</th>
                    <th>–î—ñ—è</th>
                    <th>–ú—ñ—Å—Ü—è</th>
                    <th>–°—É–º–∞</th>
                  </tr>
                </thead>
                <tbody id="cashLogBody">
                  <tr><td class="muted" colspan="4">–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ.</td></tr>
                </tbody>
              </table>
            </div>

           <div class="note">
  –ö–∞—Å–∞ –ø—Ä–∞—Ü—é—î –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—Ñ–ª–∞–π–Ω.
  <br>–ö–≤–∏—Ç–∫–∏ –¥—Ä—É–∫—É—é—Ç—å—Å—è –∑ QR-–∫–æ–¥–æ–º —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Ü—å–æ–º—É –ü–ö.
  <br>–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑ º—î–¥–Ω–∞–Ω–Ω—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ.
</div>

<div class="smallline">
  –ö–∞—Å–∏—Ä: <span class="pill" id="cashierIdPill">‚Äî</span>
</div>

          </div>
        </aside>
      </div>
    </div>
  </main>

  <div id="site-footer"></div>
  <script type="module" src="../scripts/include.js"></script>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Å–∏ (—Ü–µ–π –ü–ö)</h2>

      <div class="formRow">
        <label for="inpCashierId">cashier_id (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: kassa-1)</label>
        <input id="inpCashierId" placeholder="kassa-1" />
      </div>

     

     

      <div class="modalActions">
        <button id="btnModalClose" class="btn btn-ghost" style="padding:10px 12px;">–ó–∞–∫—Ä–∏—Ç–∏</button>
       
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const showSlug  = (qs.get("show")   || "").trim();
const SEANCE_ID = (qs.get("seance") || "").trim();

    

let SEANCE_CONFIG = null;

async function loadSeanceConfig() {
  if (!SEANCE_ID) return null;

  try {
    const res = await fetch(`../data/seances/${SEANCE_ID}.json`, {
      cache: "no-store"
    });

    if (!res.ok) return null;
    return await res.json();
  } catch {
    return null;
  }
}

    
   const parterRows = Array.from({ length: 18 }, (_, i) => ({
  row: i + 1,
  seats: 20,
  zone: "–ü–∞—Ä—Ç–µ—Ä",
  price: 0,
  className: ""
}));



    const amphiLeftRows  = [
      {row:19,seats:11},{row:20,seats:11},{row:21,seats:11},{row:22,seats:11},{row:23,seats:11},
    ].map(r=>({...r, zone:"–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä (–ª—ñ–≤–∞)", price:0, className:"seat--amphi"}));

    const amphiRightRows = [
      {row:19,seats:11},{row:20,seats:11},{row:21,seats:11},
    ].map(r=>({...r, zone:"–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä (–ø—Ä–∞–≤–∞)", price:0, className:"seat--amphi"}));

    const balconyRows15 = [1,2,3,4,5].map(n=>( { row:n, zone:"–ë–∞–ª–∫–æ–Ω", price:0, className:"seat--balcony" } ));
    const balconyRow6 = { row:6, zone:"–ë–∞–ª–∫–æ–Ω", price:0, className:"seat--balcony" };

   const lodgeSeats = Array.from({ length: 18 }, (_, i) => ({
  index: i + 1,
  price: 0,
  zone: "–õ–æ–∂–∞",
  className: ""
}));



    function seatKey(meta){
      const row = meta.row ?? 0;
      const seat = meta.seat ?? 0;
      if (meta.zone === "–ü–∞—Ä—Ç–µ—Ä") return `P${row}-M${seat}`;
      if (String(meta.zone).startsWith("–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä")) return `A${row}-M${seat}`;
      if (meta.zone === "–ë–∞–ª–∫–æ–Ω") return `B${row}-M${seat}`;
      if (meta.zone === "–õ–æ–∂–∞ –ê") return `A0-M${seat}`;
      if (meta.zone === "–õ–æ–∂–∞ –ë") return `B0-M${seat}`;
      return `P${row}-M${seat}`;
    }

    function seatKeyToHuman(k){
      const m = String(k).match(/^([PAB])(\d+)-M(\d+)$/i);
      if (!m) return k;
      const prefix = m[1].toUpperCase();
      const row = Number(m[2]);
      const seat = Number(m[3]);
      if (prefix === "P") return `–†—è–¥ ${row}, –º—ñ—Å—Ü–µ ${seat} (–ü–∞—Ä—Ç–µ—Ä)`;
      if (prefix === "A") return row === 0 ? `–õ–æ–∂–∞ –ê, –º—ñ—Å—Ü–µ ${seat}` : `–†—è–¥ ${row}, –º—ñ—Å—Ü–µ ${seat} (–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä)`;
      if (prefix === "B") return row === 0 ? `–õ–æ–∂–∞ –ë, –º—ñ—Å—Ü–µ ${seat}` : `–†—è–¥ ${row}, –º—ñ—Å—Ü–µ ${seat} (–ë–∞–ª–∫–æ–Ω)`;
      return k;
    }

    async function fetchJsonSafe(url){
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) return null;
        const txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return null; }
      }catch(e){ return null; }
    }

    // --------- ‚Äú–æ–±–æ–ª–æ—á–∫–∞ –∫–∞—Å—Å—ã‚Äù: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã + –∂—É—Ä–Ω–∞–ª ---------
    function fmtTime(ts){
      if(!ts) return "‚Äî";
      const d = new Date(ts);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    
    
    function getCashierId(){
      return localStorage.getItem("cashier_id") || "kassa-1";
    }
    function setCashierId(v){
      localStorage.setItem("cashier_id", v || "kassa-1");
      const el = document.getElementById("cashierIdPill");
      if(el) el.textContent = getCashierId();
    }
    

    // Cash log (–ª–æ–∫–∞–ª—å–Ω–æ, –ø–æ seance)
    function cashLogKey(){
      return `cash_log_${SEANCE_ID || showSlug || "unknown"}`;
    }
    function loadCashLog(){
      try{
        const raw = localStorage.getItem(cashLogKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveCashLog(arr){
      localStorage.setItem(cashLogKey(), JSON.stringify(Array.isArray(arr)?arr:[]));
      renderCashLog();
    }
    function pushCashLog(entry){
      const arr = loadCashLog();
      arr.unshift(entry);
      if(arr.length > 300) arr.length = 300;
      saveCashLog(arr);
    }
    function renderCashLog(){
      const body = document.getElementById("cashLogBody");
      if(!body) return;

      const arr = loadCashLog();
      if(!arr.length){
        body.innerHTML = `<tr><td class="muted" colspan="4">–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ.</td></tr>`;
        const rp = document.getElementById("btn-reprint");
        if(rp) rp.disabled = true;
        return;
      }
      body.innerHTML = arr.slice(0,60).map(x=>{
        const seats = Array.isArray(x.seats) ? x.seats.map(seatKeyToHuman).join("; ") : "";
        const sum = x.total || 0;
        return `
          <tr>
            <td class="muted">${fmtTime(x.ts)}</td>
            <td><b>${x.type}</b></td>
            <td>${seats}</td>
            <td><b>${sum} –≥—Ä–Ω</b></td>
          </tr>
        `;
      }).join("");

      const last = arr[0];
      const rp = document.getElementById("btn-reprint");
      if(rp) rp.disabled = !(last && last.type==="SALE" && Array.isArray(last.tickets) && last.tickets.length);
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
    }

    function toCsv(rows){
      const esc = (v)=>('"'+String(v??"").replace(/"/g,'""')+'"');
      return rows.map(r=>r.map(esc).join(",")).join("\n");
    }

    // ---- show meta / seance_id ----
    let SHOW_META = null;
// SEANCE_ID –±–µ—Ä—ë—Ç—Å—è –∏–∑ query (?seance=...)

    async function loadShowMeta(){
      if (!showSlug) return;
      const list = await fetchJsonSafe("../data/afisha.json");
      if (Array.isArray(list)) SHOW_META = list.find(x => x && x.id === showSlug) || null;

      const title = SHOW_META?.title || showSlug || "‚Äî";
      const date = SHOW_META?.date || "";
      const time = SHOW_META?.time || "";
      const dt = (date && time) ? ` ‚Ä¢ ${date} ${time}` : "";

      const t2 = String(time || "").replace(":", "-");
      SEANCE_ID = (showSlug && date && t2) ? `${showSlug}-${date}-${t2}` : "";

      const elShow = document.getElementById("summary-show");
      const elSeance = document.getElementById("summary-seance");
      if(elShow) elShow.textContent = `–í–∏—Å—Ç–∞–≤–∞: ${title}${dt}`;
      if(elSeance) elSeance.textContent = `Seance: ${SEANCE_ID || "‚Äî"}`;

      renderCashLog();
    }

    
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Å—Å—ã –ø–æ seance_id
    function cashPatchKey(){
      return `cash_patch_${SEANCE_ID || showSlug || "unknown"}`;
    }
    function loadCashPatch(){
      try{
        const raw = localStorage.getItem(cashPatchKey());
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function saveCashPatch(patch){
      localStorage.setItem(cashPatchKey(), JSON.stringify(patch || {}));
    }

   
    let CASH_PATCH = {};
    const selected = new Map(); // key -> {price}
    const seatButtons = new Map(); // key -> button

    function getEffectiveStatus(key){
  return CASH_PATCH[key]?.status || "free";
}


    function applyStatusClass(btn, status){
      btn.classList.remove("seat--sold","seat--reserved","seat--blocked");
      btn.disabled = false;
      if (status === "sold"){ btn.classList.add("seat--sold"); btn.disabled = true; }
      if (status === "reserved"){ btn.classList.add("seat--reserved"); }
      if (status === "blocked"){ btn.classList.add("seat--blocked"); btn.disabled = true; }
    }

    function applySeanceConfig(meta){
  if (!SEANCE_CONFIG) return null;

  const key = seatKey(meta);

  if (SEANCE_CONFIG.seat_overrides?.[key]) {
    return SEANCE_CONFIG.seat_overrides[key];
  }

  const zoneLetter =
    meta.zone === "–ü–∞—Ä—Ç–µ—Ä" ? "P" :
    meta.zone.startsWith("–ê–º—Ñ—ñ—Ç–µ–∞—Ç—Ä") ? "A" :
    meta.zone === "–ë–∞–ª–∫–æ–Ω" ? "B" : null;

  if (!zoneLetter) return null;

  for (const rule in SEANCE_CONFIG.pricing || {}) {
    const m = rule.match(/^([PAB])(\d+)-(\d+)$/);
    if (!m) continue;
    const [, z, from, to] = m;
    if (z === zoneLetter &&
        meta.row >= Number(from) &&
        meta.row <= Number(to)) {
      return SEANCE_CONFIG.pricing[rule]; 
    }
  }
  return null;
}

function makeSeatElement(key,label,extraClass,price,meta){
  let finalPrice = price;
  let finalClass = extraClass;
  let saleAllowed = true;

  const cfg = applySeanceConfig(meta);
  if (cfg) {
    if (cfg.price !== undefined) finalPrice = cfg.price;
    if (cfg.class) finalClass = cfg.class;
    if (cfg.sale === false) saleAllowed = false;
  }

 const btn = document.createElement("button");
btn.type = "button";
btn.textContent = label;
btn.className = "seat" + (finalClass ? " " + finalClass : "");
btn.dataset.key = key;
btn.dataset.price = String(finalPrice);

// üé® APPLY COLOR FROM SEANCE (cash)
if (cfg && cfg.color) {
  btn.style.background = cfg.color;
  btn.style.color = "#fff";
}


  applyStatusClass(btn, getEffectiveStatus(key));

  if (!saleAllowed) {
    btn.classList.add("seat--no-sale");
    btn.disabled = true;
  }

  btn.addEventListener("click", ()=>{
    const st = getEffectiveStatus(key);
    if (st === "sold" || st === "blocked" || !saleAllowed) return;

    if (btn.classList.contains("seat--selected")){
      btn.classList.remove("seat--selected");
      selected.delete(key);
    } else {
      btn.classList.add("seat--selected");
      selected.set(key, { price: finalPrice });
    }
    updateSummary();
  });

  seatButtons.set(key, btn);
  return btn;
}


    function clearSelection(){
      for (const k of selected.keys()){
        const b = seatButtons.get(k);
        if (b) b.classList.remove("seat--selected");
      }
      selected.clear();
      updateSummary();
    }

    function reapplyAllStatuses(){
      for (const [k, b] of seatButtons.entries()){
        applyStatusClass(b, getEffectiveStatus(k));
      }
    }

    function updateSummary(){
      const placesEl = document.getElementById("summary-places");
      const amountEl = document.getElementById("summary-amount");
      const btnSell = document.getElementById("btn-sell");
      const btnRes  = document.getElementById("btn-reserve");

      const keys = Array.from(selected.keys());
      if (!keys.length){
        if(placesEl) placesEl.textContent = "–û–±—Ä–∞–Ω—ñ –º—ñ—Å—Ü—è: –Ω–µ–º–∞—î";
        if(amountEl) amountEl.textContent = "–°—É–º–∞: 0 –≥—Ä–Ω";
        if(btnSell) btnSell.disabled = true;
        if(btnRes)  btnRes.disabled  = true;
        return;
      }

      const total = Array.from(selected.values()).reduce((s,x)=>s+(x.price||0),0);
      if(placesEl) placesEl.textContent = "–û–±—Ä–∞–Ω—ñ –º—ñ—Å—Ü—è: " + keys.map(seatKeyToHuman).join("; ");
      if(amountEl) amountEl.textContent = "–°—É–º–∞: " + total + " –≥—Ä–Ω";
      if(btnSell) btnSell.disabled = false;
      if(btnRes)  btnRes.disabled  = false;
            // === SEND BASKET TO BACKOFFICE ===
      if (window.parent && EMBED) {
        window.parent.postMessage(
          {
            source: "hall-cash",
            type: "basket:update",
            payload: {
              seats: Array.from(selected.keys()),
              total
            }
          },
          "*"
        );
      }

    }

    function applyStatusToSelectedLocal(status){
      const keys = Array.from(selected.keys());
      if (!keys.length) return;

      
     for (const k of keys){
  CASH_PATCH[k] = { status, ts: Date.now() };
}
saveCashPatch(CASH_PATCH);
      pushCashLog({
        ts: Date.now(),
        type: status === "reserved" ? "RESERVE" : String(status||"").toUpperCase(),
        seats: keys,
        total: Array.from(selected.values()).reduce((s,x)=>s+(x.price||0),0)
      });

      clearSelection();
      reapplyAllStatuses();
    }

    // ---- op_id generator ----
    function genOpId(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      const rnd = Math.random().toString(16).slice(2,8);
      return `KR-SHEV-${yyyy}${mm}${dd}-${hh}${mi}${ss}-${rnd}`;
    }

   

// ---- –ø–µ—á–∞—Ç—å –±–∏–ª–µ—Ç–æ–≤ (—Å QR) ----
    async function openPrintWindowOffline(tickets, meta){
      const theatre = "–¢–µ–∞—Ç—Ä —ñ–º. –¢. –ì. –®–µ–≤—á–µ–Ω–∫–∞";
      const title = meta?.title || showSlug || "–ö–≤–∏—Ç–æ–∫";
      const dt = (meta?.date && meta?.time) ? `${meta.date} ${meta.time}` : "";
      const seance = SEANCE_ID || "";

      const cardsHtml = [];
      for (const t of tickets){
        const payload = `order:${t.order_id}|show:${t.show_slug}|seat:${t.seat_label}`;

        let qrDataUrl = "";
        try{
          qrDataUrl = await window.QRCode.toDataURL(payload, { width: 320, margin: 2, errorCorrectionLevel: "M" });

        }catch(e){ qrDataUrl = ""; }

        cardsHtml.push(`
          <div class="t">
            <div class="h">
              <div class="theatre">${theatre}</div>
              <div class="ord">–ö–∞–Ω–∞–ª: –ö–∞—Å–∞<br/>OP: ${t.op_id}</div>
            </div>
            <div class="show">${title}</div>
            <div class="meta">
              ${dt ? `<div>–î–∞—Ç–∞/—á–∞—Å: ${dt}</div>` : ``}
              <div><b>${seatKeyToHuman(t.seat_label)}</b></div>
              ${seance ? `<div class="muted">Seance: ${seance}</div>` : ``}
              <div class="muted">Order: ${t.order_id}</div>
            </div>
            <div class="price">–¶—ñ–Ω–∞: ${t.price} –≥—Ä–Ω</div>

            ${qrDataUrl ? `<img class="qr" src="${qrDataUrl}" alt="QR"/>` : `<div class="qr-miss">QR –Ω–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ</div>`}

            <div class="note">
              –ö–≤–∏—Ç–æ–∫ –¥—ñ–π—Å–Ω–∏–π –Ω–∞ –æ–¥–Ω—É –æ—Å–æ–±—É. –ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ –¥–æ –∫—ñ–Ω—Ü—è –≤–∏—Å—Ç–∞–≤–∏.<br/>
              
            </div>
          </div>
        `);
      }

      const html = `<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–î—Ä—É–∫ –∫–≤–∏—Ç–∫—ñ–≤</title>
<style>
  body{font-family:Arial,sans-serif;margin:16px;color:#111827;}
  .wrap{display:flex;flex-wrap:wrap;gap:14px;}
  .t{width:320px;border:1px solid #e5e7eb;border-radius:14px;padding:12px;}
  .h{display:flex;justify-content:space-between;gap:10px;margin-bottom:6px;}
  .theatre{font-weight:700;font-size:12px;}
  .ord{font-size:11px;color:#6b7280;text-align:right;}
  .show{font-size:14px;font-weight:800;margin:6px 0 4px;}
  .meta{font-size:12px;color:#374151;line-height:1.35;}
  .muted{font-size:11px;color:#6b7280;margin-top:4px;}
  .price{margin-top:8px;font-size:14px;font-weight:800;}
  .qr{display:block;margin:10px auto 6px;width:190px;height:190px;border:1px solid #e5e7eb;border-radius:10px;}
  .qr-miss{margin:10px 0;padding:10px;border:1px dashed #e5e7eb;border-radius:10px;color:#6b7280;text-align:center;}
  .note{font-size:10px;color:#6b7280;line-height:1.3;margin-top:8px;}
</style>
</head>
<body>
  <div class="wrap">${cardsHtml.join("")}</div>
</body>
</html>`;

      const w = window.open("", "_blank");
      if (!w){ alert("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫—É–≤–∞–≤ pop-up. –î–æ–∑–≤–æ–ª—å –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –≤—ñ–∫–æ–Ω –¥–ª—è –¥—Ä—É–∫—É."); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();

      setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){} }, 250);
    }


    
    
   function calcCashOrderId(seanceId, showSlug, opId){
  return `CASH-${seanceId}-${opId}`;
} 

    // ---- –ü–†–û–î–ê–ñ–ê (–æ—Ñ–ª–∞–π–Ω) ----
    async function sellAndPrintOffline(){
      const keys = Array.from(selected.keys());
      if (!keys.length) return;

      if (!SEANCE_ID){
        alert("–ù–µ–º–∞—î seance_id (–ø–æ—Ç—Ä—ñ–±–Ω—ñ date/time –≤ afisha.json).");
        return;
      }

      const op_id = genOpId();

      const prices = {};
      for (const k of keys) prices[k] = Number(selected.get(k)?.price || 0);

      const op = {
        op_id,
        type: "sale",
        seance_id: SEANCE_ID,
        show_slug: showSlug,
        seats: keys,
        prices,
        sold_at: new Date().toISOString(),
      };

      

      for (const k of keys){
        if (takenSeatsOnline.has(k)) continue;
        CASH_PATCH[k] = { status: "sold", ts: Date.now(), op_id };
      }
      saveCashPatch(CASH_PATCH);

      const order_id = calcCashOrderId(SEANCE_ID, showSlug, op_id);
      const tickets = keys.map(k => ({
        op_id,
        order_id,
        show_slug: showSlug,
        seat_label: k,
        price: Number(prices[k] || 0),
      }));

      pushCashLog({
        ts: Date.now(),
        type: "SALE",
        seats: keys,
        total: tickets.reduce((s,t)=>s+(t.price||0),0),
        tickets
      });

      clearSelection();
      reapplyAllStatuses();
      await openPrintWindowOffline(tickets, SHOW_META);

}

    // ---- reprint last sale ----
    async function reprintLastSale(){
      const arr = loadCashLog();
      const last = arr.find(x=>x && x.type==="SALE" && Array.isArray(x.tickets) && x.tickets.length) || null;
      if (!last){ alert("–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –ø—Ä–æ–¥–∞–∂—ñ –¥–ª—è –¥—Ä—É–∫—É."); return; }
      await openPrintWindowOffline(last.tickets, SHOW_META);
    }

    // ---- render blocks ----
    function renderParter(){
      const block = document.getElementById("parter-block");
      block.innerHTML = "";
      parterRows.forEach(r=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div");
        lab.className = "row-label";
        lab.textContent = r.row;
        rowLine.appendChild(lab);

        const seatsRow = document.createElement("div");
        seatsRow.className = "seats-row";

        for (let s=1; s<=r.seats; s++){
          const meta = { zone:"–ü–∞—Ä—Ç–µ—Ä", row:r.row, seat:s };
const cls = r.className + (s===10 ? " seat--gap-right" : "");
seatsRow.appendChild(
  makeSeatElement(seatKey(meta), s, cls, r.price, meta)
);


        }

        rowLine.appendChild(seatsRow);
        block.appendChild(rowLine);
      });
    }

    function renderLodges(){
      const a = document.getElementById("lodge-a-seats");
      const b = document.getElementById("lodge-b-seats");
      a.innerHTML = ""; b.innerHTML = "";

      lodgeSeats.forEach(ls=>{
        const metaA = { zone:"–õ–æ–∂–∞ –ê", row:0, seat:ls.index };
const metaB = { zone:"–õ–æ–∂–∞ –ë", row:0, seat:ls.index };

a.appendChild(makeSeatElement(seatKey(metaA), ls.index, ls.className, 10, metaA));
b.appendChild(makeSeatElement(seatKey(metaB), ls.index, ls.className, 10, metaB));

      });
    }

    function renderAmphi(){
      const block = document.getElementById("amphi-block");
      block.innerHTML = "";
      [19,20,21,22,23].forEach(rowNum=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div");
        lab.className = "row-label";
        lab.textContent = rowNum;
        rowLine.appendChild(lab);

        const left = document.createElement("div");
        left.className = "seats-row";
        const right = document.createElement("div");
        right.className = "seats-row";
        const gap = document.createElement("div");
        gap.className = "amphi-gap";

        const leftCfg = amphiLeftRows.find(r=>r.row===rowNum);
        const rightCfg = amphiRightRows.find(r=>r.row===rowNum);

        if (leftCfg){
          for(let s=1;s<=leftCfg.seats;s++){
            const meta = { zone:leftCfg.zone, row:rowNum, seat:s };
left.appendChild(makeSeatElement(seatKey(meta), s, leftCfg.className, 120, meta));

          }
        }
        if (rightCfg){
          for(let s=1;s<=rightCfg.seats;s++){
            const seatNum = s+11;
            const meta = { zone:rightCfg.zone, row:rowNum, seat:seatNum };
right.appendChild(makeSeatElement(seatKey(meta), seatNum, rightCfg.className, 120, meta));

          }
        }

        rowLine.appendChild(left);
        rowLine.appendChild(gap);
        rowLine.appendChild(right);
        block.appendChild(rowLine);
      });
    }

    function renderBalcony(){
      const block = document.getElementById("balcony-block");
      block.innerHTML = "";

      balconyRows15.forEach(r=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div"); 
        lab.className = "row-label";
        lab.textContent = r.row;
        rowLine.appendChild(lab);

        const seatsRow = document.createElement("div");
        seatsRow.className = "seats-row";

        for(let pos=1;pos<=28;pos++){
          const meta = { zone:"–ë–∞–ª–∫–æ–Ω", row:6, seat:pos };

const cls  = r.className + (pos === 14 ? " seat--gap-right" : "");
seatsRow.appendChild(
  makeSeatElement(
    seatKey(meta),
    pos,
    cls,
    100,
    meta
  )
);

        }

        rowLine.appendChild(seatsRow);
        block.appendChild(rowLine);
      });

      const rowLine = document.createElement("div");
      rowLine.className = "row-line";

      const lab = document.createElement("div");
      lab.className = "row-label";
      lab.textContent = 6;
      rowLine.appendChild(lab);

      const seatsRow = document.createElement("div");
      seatsRow.className = "seats-row";

      for(let pos=1;pos<=28;pos++){
        if (pos<=10){
          const meta = { zone:"–ë–∞–ª–∫–æ–Ω", row:6, seat:pos };
const cls = "seat--balcony" + (pos === 14 ? " seat--gap-right" : "");
seatsRow.appendChild(
  makeSeatElement(
    seatKey(meta),
    pos,
    cls,
    100,
    meta
  )
);

        } else if (pos>=19){
          const seatNum = pos-8;
          const meta = { zone: "–ë–∞–ª–∫–æ–Ω", row: 6, seat: seatNum };
seatsRow.appendChild(
  makeSeatElement(
    seatKey(meta),
    seatNum,
    "seat--balcony",
    80,
    meta
  )
);
        } else {
          const empty = document.createElement("button");
          empty.type="button";
          empty.className="seat seat--empty";
          seatsRow.appendChild(empty);
        }
      }

      rowLine.appendChild(seatsRow);
      block.appendChild(rowLine);
    }

    // ---- –∫–Ω–æ–ø–∫–∏ ----
    document.getElementById("btn-clear")?.addEventListener("click", ()=> clearSelection());
    document.getElementById("btn-reserve")?.addEventListener("click", ()=> applyStatusToSelectedLocal("reserved"));
    document.getElementById("btn-sell")?.addEventListener("click", ()=> sellAndPrintOffline());
   
    document.getElementById("btn-reprint")?.addEventListener("click", ()=> reprintLastSale());

    document.getElementById("btn-reset")?.addEventListener("click", ()=>{
      if (!confirm("–°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –∫–∞—Å–æ–≤—ñ —Å—Ç–∞–Ω–∏ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É –Ω–∞ —Ü—å–æ–º—É –ü–ö?")) return;
      CASH_PATCH = {};
      saveCashPatch(CASH_PATCH);
      clearSelection();
      reapplyAllStatuses();
      alert("–õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ —Å–∫–∏–Ω—É—Ç–æ.");
    });

    // export cash log CSV
    document.getElementById("btnExportCashCsv")?.addEventListener("click", ()=>{
      const arr = loadCashLog();
      const rows = [["time","type","seats","total"]];
      for(const x of arr){
        const seats = Array.isArray(x.seats) ? x.seats.join(";") : "";
        rows.push([new Date(x.ts||0).toISOString(), x.type||"", seats, String(x.total||0)]);
      }
      const name = `cash_log_${showSlug || "show"}_${(SEANCE_ID||"").replaceAll(":","-")}.csv`;
      downloadText(name, toCsv(rows));
    });

    document.getElementById("btnClearCashLog")?.addEventListener("click", ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏–π –∂—É—Ä–Ω–∞–ª –∫–∞—Å–∏ –¥–ª—è —Ü—å–æ–≥–æ —Å–µ–∞–Ω—Å—É?")) return;
      saveCashLog([]);
    });

   
    // Settings modal
    const modalBack = document.getElementById("modalBack");
    function openModal(){
      document.getElementById("inpCashierId").value = getCashierId();
      document.getElementById("inpSecret").value = getCashierSecret();
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; }
    document.getElementById("btnSettings")?.addEventListener("click", openModal);
    document.getElementById("btnModalClose")?.addEventListener("click", closeModal);
    document.getElementById("btnModalSave")?.addEventListener("click", ()=>{
      const id = (document.getElementById("inpCashierId").value || "").trim() || "kassa-1";
      const sec = (document.getElementById("inpSecret").value || "").trim();
      setCashierId(id);
      setCashierSecret(sec);
      closeModal();
      alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ.");
    });
    modalBack?.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

   
    // ---- boot ----
    (async ()=>{
      
      setCashierId(getCashierId());

      
      await loadShowMeta();
SEANCE_CONFIG = await loadSeanceConfig();
CASH_PATCH = loadCashPatch();


      renderParter();
      renderLodges();
      renderAmphi();
      renderBalcony();
      updateSummary();
      renderCashLog();
    })();
  </script>
</body>
</html>
